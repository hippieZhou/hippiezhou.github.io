name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # æ„å»ºå’Œæµ‹è¯•ä½œä¸š
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: "20"
    defaults:
      run:
        shell: bash
        working-directory: ./src

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºç¼“å­˜ä¼˜åŒ–

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "./src/package-lock.json"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            ./src/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Check for security vulnerabilities
        run: npm audit --audit-level=moderate || true

      - name: Clean previous build
        run: |
          echo "ğŸ§¹ Cleaning previous build..."
          npm run clean || echo "Clean command completed"
          rm -rf public/ || echo "No previous public directory to remove"

      - name: Build site
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verify build success
        run: |
          echo "ğŸ” Verifying build success..."
          if [ ! -d "public" ]; then
            echo "âŒ Build failed: public directory not found"
            echo "ğŸ” Checking for build errors..."
            echo "Current directory: $(pwd)"
            ls -la
            echo "ğŸ” Checking for any generated files..."
            find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" | head -10
            exit 1
          fi
          echo "âœ… Build successful: public directory found"

      - name: Debug build output
        run: |
          echo "ğŸ” Debugging build output..."
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo ""
          echo "Checking for public directory:"
          if [ -d "public" ]; then
            echo "âœ… Public directory exists"
            echo "Public directory contents:"
            ls -la public/ | head -10
            echo "Total files in public: $(find public -type f | wc -l)"
          else
            echo "âŒ Public directory not found"
            echo "Looking for other possible output directories:"
            find . -maxdepth 2 -type d -name "*public*" -o -name "*dist*" -o -name "*build*" 2>/dev/null || echo "No common output directories found"
          fi

      - name: Clean problematic files
        run: |
          echo "ğŸ§¹ Cleaning problematic files..."

          # æ£€æŸ¥ public ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "public" ]; then
            echo "âš ï¸  Public directory not found, skipping cleanup"
            exit 0
          fi

          echo "ğŸ“Š Checking artifact size and content..."

          # åˆ é™¤ Zone.Identifier æ–‡ä»¶
          find ./public -name "*:Zone.Identifier" -type f -delete
          find ./public -name "*.Zone.Identifier" -type f -delete

          # åˆ é™¤å…¶ä»–å¯èƒ½åŒ…å«å†’å·çš„æ–‡ä»¶
          find ./public -name "*:*" -type f -delete

          # åˆ é™¤éšè—æ–‡ä»¶
          find ./public -name ".*" -type f -delete

          # åˆ é™¤ macOS ç³»ç»Ÿæ–‡ä»¶
          find ./public -name ".DS_Store" -type f -delete
          find ./public -name "Thumbs.db" -type f -delete

          # åˆ é™¤ç¬¦å·é“¾æ¥
          find ./public -type l -delete

          # å¤„ç†ç¡¬é“¾æ¥ï¼ˆä¿ç•™ä¸€ä¸ªå‰¯æœ¬ï¼Œåˆ é™¤é‡å¤çš„ï¼‰
          echo "ğŸ” Checking for hard links..."
          find ./public -type f -exec ls -i {} \; | awk '{print $1}' | sort | uniq -d | while read inode; do
            echo "âš ï¸  Found hard links with inode $inode"
            # æ‰¾åˆ°æ‰€æœ‰å…·æœ‰ç›¸åŒ inode çš„æ–‡ä»¶
            files=$(find ./public -type f -inum "$inode")
            # ä¿ç•™ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ é™¤å…¶ä½™çš„
            first_file=$(echo "$files" | head -1)
            echo "  Keeping: $first_file"
            echo "$files" | tail -n +2 | xargs rm -f
          done

          # æ£€æŸ¥æ€»å¤§å°
          TOTAL_SIZE_BYTES=$(du -sb ./public | cut -f1)
          TOTAL_SIZE_GB=$(echo "scale=2; $TOTAL_SIZE_BYTES / 1024 / 1024 / 1024" | bc -l 2>/dev/null || echo "0")
          echo "ğŸ“Š Total artifact size: $(du -sh ./public | cut -f1) ($TOTAL_SIZE_GB GB)"

          # æ£€æŸ¥æ˜¯å¦è¶…è¿‡ 10GB é™åˆ¶
          if (( $(echo "$TOTAL_SIZE_GB > 10" | bc -l) )); then
            echo "âŒ Artifact size exceeds 10GB limit: $TOTAL_SIZE_GB GB"
            echo "ğŸ” Largest files:"
            find ./public -type f -exec ls -lh {} \; | sort -k5 -hr | head -10
            exit 1
          fi

          # æ£€æŸ¥æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find ./public -type f | wc -l)
          echo "ğŸ“Š Total files: $FILE_COUNT"

          # åˆ—å‡ºæœ€å¤§çš„æ–‡ä»¶
          echo "ğŸ” Largest files:"
          find ./public -type f -exec ls -lh {} \; | sort -k5 -hr | head -5

          echo "âœ… Problematic files cleaned"

      - name: Test build output
        run: |
          if [ ! -d "public" ]; then
            echo "âŒ Build failed: public directory not found"
            exit 1
          fi
          echo "âœ… Build successful: $(find public -type f | wc -l) files generated"

      - name: Verify build output
        run: |
          echo "ğŸ“¦ Verifying build output..."
          if [ -d "./public" ]; then
            echo "âœ… Public directory exists with $(find ./public -type f | wc -l) files"
            ls -la ./public/ | head -5
          else
            echo "âŒ Public directory not found"
            exit 1
          fi

  # éƒ¨ç½²ä½œä¸š
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      pages: write
      id-token: write
      contents: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./src/package-lock.json"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        working-directory: ./src

      - name: Build site
        run: npm run build
        env:
          NODE_ENV: production
        working-directory: ./src

      - name: Clean problematic files
        run: |
          echo "ğŸ§¹ Cleaning problematic files..."

          # æ£€æŸ¥ public ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "public" ]; then
            echo "âš ï¸  Public directory not found, skipping cleanup"
            exit 0
          fi

          echo "ğŸ“Š Checking artifact size and content..."

          # åˆ é™¤ Zone.Identifier æ–‡ä»¶
          find ./public -name "*:Zone.Identifier" -type f -delete
          find ./public -name "*.Zone.Identifier" -type f -delete

          # åˆ é™¤å…¶ä»–å¯èƒ½åŒ…å«å†’å·çš„æ–‡ä»¶
          find ./public -name "*:*" -type f -delete

          # åˆ é™¤éšè—æ–‡ä»¶
          find ./public -name ".*" -type f -delete

          # åˆ é™¤ macOS ç³»ç»Ÿæ–‡ä»¶
          find ./public -name ".DS_Store" -type f -delete
          find ./public -name "Thumbs.db" -type f -delete

          # åˆ é™¤ç¬¦å·é“¾æ¥
          find ./public -type l -delete

          # å¤„ç†ç¡¬é“¾æ¥ï¼ˆä¿ç•™ä¸€ä¸ªå‰¯æœ¬ï¼Œåˆ é™¤é‡å¤çš„ï¼‰
          echo "ğŸ” Checking for hard links..."
          find ./public -type f -exec ls -i {} \; | awk '{print $1}' | sort | uniq -d | while read inode; do
            echo "âš ï¸  Found hard links with inode $inode"
            # æ‰¾åˆ°æ‰€æœ‰å…·æœ‰ç›¸åŒ inode çš„æ–‡ä»¶
            files=$(find ./public -type f -inum "$inode")
            # ä¿ç•™ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ é™¤å…¶ä½™çš„
            first_file=$(echo "$files" | head -1)
            echo "  Keeping: $first_file"
            echo "$files" | tail -n +2 | xargs rm -f
          done

          # æ£€æŸ¥æ€»å¤§å°
          TOTAL_SIZE_BYTES=$(du -sb ./public | cut -f1)
          TOTAL_SIZE_GB=$(echo "scale=2; $TOTAL_SIZE_BYTES / 1024 / 1024 / 1024" | bc -l 2>/dev/null || echo "0")
          echo "ğŸ“Š Total artifact size: $(du -sh ./public | cut -f1) ($TOTAL_SIZE_GB GB)"

          # æ£€æŸ¥æ˜¯å¦è¶…è¿‡ 10GB é™åˆ¶
          if (( $(echo "$TOTAL_SIZE_GB > 10" | bc -l) )); then
            echo "âŒ Artifact size exceeds 10GB limit: $TOTAL_SIZE_GB GB"
            echo "ğŸ” Largest files:"
            find ./public -type f -exec ls -lh {} \; | sort -k5 -hr | head -10
            exit 1
          fi

          # æ£€æŸ¥æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find ./public -type f | wc -l)
          echo "ğŸ“Š Total files: $FILE_COUNT"

          # åˆ—å‡ºæœ€å¤§çš„æ–‡ä»¶
          echo "ğŸ” Largest files:"
          find ./public -type f -exec ls -lh {} \; | sort -k5 -hr | head -5

          echo "âœ… Problematic files cleaned"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./src/public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Verify deployment
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful to ${{ steps.deployment.outputs.page_url }}"
          else
            echo "âŒ Deployment failed"
            exit 1
          fi

  # æ€§èƒ½æ£€æŸ¥ä½œä¸š
  performance-check:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: ./site-build

      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh ./site-build | cut -f1)
          echo "ğŸ“Š Build size: $BUILD_SIZE"

          # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡å¤§çš„æ–‡ä»¶
          LARGE_FILES=$(find ./site-build -type f -size +1M | wc -l)
          if [ $LARGE_FILES -gt 0 ]; then
            echo "âš ï¸  Found $LARGE_FILES files larger than 1MB"
            find ./site-build -type f -size +1M -exec ls -lh {} \;
          else
            echo "âœ… No large files detected"
          fi

      - name: Check for broken links (basic)
        run: |
          # ç®€å•çš„é“¾æ¥æ£€æŸ¥
          HTML_FILES=$(find ./site-build -name "*.html" | head -5)
          for file in $HTML_FILES; do
            echo "Checking $file..."
            grep -o 'href="[^"]*"' "$file" | head -3 || true
          done
