name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # æ„å»ºå’Œæµ‹è¯•ä½œä¸š
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: "20"
    defaults:
      run:
        shell: bash
        working-directory: ./src

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºç¼“å­˜ä¼˜åŒ–

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "./src/package-lock.json"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            ./src/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Check for security vulnerabilities
        run: npm audit --audit-level=moderate || true

      - name: Build site
        run: npm run build
        env:
          NODE_ENV: production

      - name: Clean problematic files
        run: |
          echo "ğŸ§¹ Cleaning problematic files..."

          # æ£€æŸ¥ public ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "public" ]; then
            echo "âš ï¸  Public directory not found, skipping cleanup"
            exit 0
          fi

          # åˆ é™¤ Zone.Identifier æ–‡ä»¶
          find ./public -name "*:Zone.Identifier" -type f -delete
          find ./public -name "*.Zone.Identifier" -type f -delete

          # åˆ é™¤å…¶ä»–å¯èƒ½åŒ…å«å†’å·çš„æ–‡ä»¶
          find ./public -name "*:*" -type f -delete

          # åˆ é™¤éšè—æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          find ./public -name ".*" -type f -delete

          # åˆ é™¤ macOS ç³»ç»Ÿæ–‡ä»¶
          find ./public -name ".DS_Store" -type f -delete
          find ./public -name "Thumbs.db" -type f -delete

          echo "âœ… Problematic files cleaned"

      - name: Test build output
        run: |
          if [ ! -d "public" ]; then
            echo "âŒ Build failed: public directory not found"
            exit 1
          fi
          echo "âœ… Build successful: $(find public -type f | wc -l) files generated"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: ./public
          retention-days: 7
          if-no-files-found: error

      - name: Verify artifact upload
        run: |
          echo "ğŸ“¦ Verifying artifact upload..."
          ls -la ./public/ || echo "âš ï¸  Public directory not found"
          echo "âœ… Artifact upload verification completed"

  # éƒ¨ç½²ä½œä¸š
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      pages: write
      id-token: write
      contents: read

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: ./site-build

      - name: Verify downloaded artifacts
        run: |
          echo "ğŸ“¦ Verifying downloaded artifacts..."
          if [ ! -d "./site-build" ]; then
            echo "âŒ Site build directory not found"
            exit 1
          fi
          echo "âœ… Found $(find ./site-build -type f | wc -l) files in site-build"
          ls -la ./site-build/ | head -10

      - name: Upload to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Verify deployment
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful to ${{ steps.deployment.outputs.page_url }}"
          else
            echo "âŒ Deployment failed"
            exit 1
          fi

  # æ€§èƒ½æ£€æŸ¥ä½œä¸š
  performance-check:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: ./site-build

      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh ./site-build | cut -f1)
          echo "ğŸ“Š Build size: $BUILD_SIZE"

          # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡å¤§çš„æ–‡ä»¶
          LARGE_FILES=$(find ./site-build -type f -size +1M | wc -l)
          if [ $LARGE_FILES -gt 0 ]; then
            echo "âš ï¸  Found $LARGE_FILES files larger than 1MB"
            find ./site-build -type f -size +1M -exec ls -lh {} \;
          else
            echo "âœ… No large files detected"
          fi

      - name: Check for broken links (basic)
        run: |
          # ç®€å•çš„é“¾æ¥æ£€æŸ¥
          HTML_FILES=$(find ./site-build -name "*.html" | head -5)
          for file in $HTML_FILES; do
            echo "Checking $file..."
            grep -o 'href="[^"]*"' "$file" | head -3 || true
          done
