name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # 构建和测试作业
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: "20"
    defaults:
      run:
        shell: bash
        working-directory: ./src

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0 # 获取完整历史用于缓存优化

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "./src/package-lock.json"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            ./src/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            ${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Check for security vulnerabilities
        run: npm audit --audit-level=moderate || true

      - name: Clean previous build
        run: |
          echo "🧹 Cleaning previous build..."
          npm run clean || echo "Clean command completed"
          rm -rf public/ || echo "No previous public directory to remove"

      - name: Build site
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verify build success
        run: |
          echo "🔍 Verifying build success..."
          if [ ! -d "public" ]; then
            echo "❌ Build failed: public directory not found"
            echo "🔍 Checking for build errors..."
            echo "Current directory: $(pwd)"
            ls -la
            echo "🔍 Checking for any generated files..."
            find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" | head -10
            exit 1
          fi
          echo "✅ Build successful: public directory found"

      - name: Debug build output
        run: |
          echo "🔍 Debugging build output..."
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo ""
          echo "Checking for public directory:"
          if [ -d "public" ]; then
            echo "✅ Public directory exists"
            echo "Public directory contents:"
            ls -la public/ | head -10
            echo "Total files in public: $(find public -type f | wc -l)"
          else
            echo "❌ Public directory not found"
            echo "Looking for other possible output directories:"
            find . -maxdepth 2 -type d -name "*public*" -o -name "*dist*" -o -name "*build*" 2>/dev/null || echo "No common output directories found"
          fi

      - name: Clean problematic files
        run: |
          echo "🧹 Cleaning problematic files..."

          # 检查 public 目录是否存在
          if [ ! -d "public" ]; then
            echo "⚠️  Public directory not found, skipping cleanup"
            exit 0
          fi

          echo "📊 Checking artifact size and content..."

          # 删除 Zone.Identifier 文件
          find ./public -name "*:Zone.Identifier" -type f -delete
          find ./public -name "*.Zone.Identifier" -type f -delete

          # 删除其他可能包含冒号的文件
          find ./public -name "*:*" -type f -delete

          # 删除隐藏文件
          find ./public -name ".*" -type f -delete

          # 删除 macOS 系统文件
          find ./public -name ".DS_Store" -type f -delete
          find ./public -name "Thumbs.db" -type f -delete

          # 删除符号链接
          find ./public -type l -delete

          # 处理硬链接（保留一个副本，删除重复的）
          echo "🔍 Checking for hard links..."
          find ./public -type f -exec ls -i {} \; | awk '{print $1}' | sort | uniq -d | while read inode; do
            echo "⚠️  Found hard links with inode $inode"
            # 找到所有具有相同 inode 的文件
            files=$(find ./public -type f -inum "$inode")
            # 保留第一个文件，删除其余的
            first_file=$(echo "$files" | head -1)
            echo "  Keeping: $first_file"
            echo "$files" | tail -n +2 | xargs rm -f
          done

          # 检查总大小
          TOTAL_SIZE_BYTES=$(du -sb ./public | cut -f1)
          TOTAL_SIZE_GB=$(echo "scale=2; $TOTAL_SIZE_BYTES / 1024 / 1024 / 1024" | bc -l 2>/dev/null || echo "0")
          echo "📊 Total artifact size: $(du -sh ./public | cut -f1) ($TOTAL_SIZE_GB GB)"

          # 检查是否超过 10GB 限制
          if (( $(echo "$TOTAL_SIZE_GB > 10" | bc -l) )); then
            echo "❌ Artifact size exceeds 10GB limit: $TOTAL_SIZE_GB GB"
            echo "🔍 Largest files:"
            find ./public -type f -exec ls -lh {} \; | sort -k5 -hr | head -10
            exit 1
          fi

          # 检查文件数量
          FILE_COUNT=$(find ./public -type f | wc -l)
          echo "📊 Total files: $FILE_COUNT"

          # 列出最大的文件
          echo "🔍 Largest files:"
          find ./public -type f -exec ls -lh {} \; | sort -k5 -hr | head -5

          echo "✅ Problematic files cleaned"

      - name: Test build output
        run: |
          if [ ! -d "public" ]; then
            echo "❌ Build failed: public directory not found"
            exit 1
          fi
          echo "✅ Build successful: $(find public -type f | wc -l) files generated"

      - name: Verify build output
        run: |
          echo "📦 Verifying build output..."
          if [ -d "./public" ]; then
            echo "✅ Public directory exists with $(find ./public -type f | wc -l) files"
            ls -la ./public/ | head -5
          else
            echo "❌ Public directory not found"
            exit 1
          fi

  # 部署作业
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      pages: write
      id-token: write
      contents: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./src/package-lock.json"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        working-directory: ./src

      - name: Build site
        run: npm run build
        env:
          NODE_ENV: production
        working-directory: ./src

      - name: Clean problematic files
        run: |
          echo "🧹 Cleaning problematic files..."

          # 检查 public 目录是否存在
          if [ ! -d "public" ]; then
            echo "⚠️  Public directory not found, skipping cleanup"
            exit 0
          fi

          echo "📊 Checking artifact size and content..."

          # 删除 Zone.Identifier 文件
          find ./public -name "*:Zone.Identifier" -type f -delete
          find ./public -name "*.Zone.Identifier" -type f -delete

          # 删除其他可能包含冒号的文件
          find ./public -name "*:*" -type f -delete

          # 删除隐藏文件
          find ./public -name ".*" -type f -delete

          # 删除 macOS 系统文件
          find ./public -name ".DS_Store" -type f -delete
          find ./public -name "Thumbs.db" -type f -delete

          # 删除符号链接
          find ./public -type l -delete

          # 处理硬链接（保留一个副本，删除重复的）
          echo "🔍 Checking for hard links..."
          find ./public -type f -exec ls -i {} \; | awk '{print $1}' | sort | uniq -d | while read inode; do
            echo "⚠️  Found hard links with inode $inode"
            # 找到所有具有相同 inode 的文件
            files=$(find ./public -type f -inum "$inode")
            # 保留第一个文件，删除其余的
            first_file=$(echo "$files" | head -1)
            echo "  Keeping: $first_file"
            echo "$files" | tail -n +2 | xargs rm -f
          done

          # 检查总大小
          TOTAL_SIZE_BYTES=$(du -sb ./public | cut -f1)
          TOTAL_SIZE_GB=$(echo "scale=2; $TOTAL_SIZE_BYTES / 1024 / 1024 / 1024" | bc -l 2>/dev/null || echo "0")
          echo "📊 Total artifact size: $(du -sh ./public | cut -f1) ($TOTAL_SIZE_GB GB)"

          # 检查是否超过 10GB 限制
          if (( $(echo "$TOTAL_SIZE_GB > 10" | bc -l) )); then
            echo "❌ Artifact size exceeds 10GB limit: $TOTAL_SIZE_GB GB"
            echo "🔍 Largest files:"
            find ./public -type f -exec ls -lh {} \; | sort -k5 -hr | head -10
            exit 1
          fi

          # 检查文件数量
          FILE_COUNT=$(find ./public -type f | wc -l)
          echo "📊 Total files: $FILE_COUNT"

          # 列出最大的文件
          echo "🔍 Largest files:"
          find ./public -type f -exec ls -lh {} \; | sort -k5 -hr | head -5

          echo "✅ Problematic files cleaned"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./src/public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Verify deployment
        run: |
          echo "🚀 Deployment completed successfully!"
          echo "🌐 Site URL: ${{ steps.deployment.outputs.page_url }}"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful to ${{ steps.deployment.outputs.page_url }}"
          else
            echo "❌ Deployment failed"
            exit 1
          fi

  # 性能检查作业
  performance-check:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: ./site-build

      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh ./site-build | cut -f1)
          echo "📊 Build size: $BUILD_SIZE"

          # 检查是否有过大的文件
          LARGE_FILES=$(find ./site-build -type f -size +1M | wc -l)
          if [ $LARGE_FILES -gt 0 ]; then
            echo "⚠️  Found $LARGE_FILES files larger than 1MB"
            find ./site-build -type f -size +1M -exec ls -lh {} \;
          else
            echo "✅ No large files detected"
          fi

      - name: Check for broken links (basic)
        run: |
          # 简单的链接检查
          HTML_FILES=$(find ./site-build -name "*.html" | head -5)
          for file in $HTML_FILES; do
            echo "Checking $file..."
            grep -o 'href="[^"]*"' "$file" | head -3 || true
          done
