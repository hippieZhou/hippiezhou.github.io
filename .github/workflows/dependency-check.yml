name: Dependency Check & Security Audit

on:
  schedule:
    # 每周一凌晨2点运行
    - cron: '0 2 * * 1'
  workflow_dispatch:
  push:
    paths:
      - 'src/package.json'
      - 'src/package-lock.json'

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./src
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './src/package-lock.json'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for outdated packages
        id: outdated
        run: |
          echo "Checking for outdated packages..."
          OUTDATED=$(npm outdated --json || echo "{}")
          echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT
          
          if [ "$OUTDATED" != "{}" ]; then
            echo "⚠️ Found outdated packages:"
            echo "$OUTDATED" | jq -r 'to_entries[] | "  \(.key): \(.value.current) -> \(.value.latest)"'
          else
            echo "✅ All packages are up to date"
          fi
      
      - name: Security audit
        id: audit
        run: |
          echo "Running security audit..."
          npm audit --audit-level=moderate --json > audit-report.json || true
          
          VULNERABILITIES=$(jq -r '.metadata.vulnerabilities.total // 0' audit-report.json)
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "🚨 Found $VULNERABILITIES vulnerabilities:"
            jq -r '.advisories | to_entries[] | "  \(.value.title) (Severity: \(.value.severity))"' audit-report.json || true
          else
            echo "✅ No vulnerabilities found"
          fi
      
      - name: Create issue for outdated dependencies
        if: steps.outdated.outputs.outdated != '{}'
        uses: actions/github-script@v7
        with:
          script: |
            const outdated = JSON.parse('${{ steps.outdated.outputs.outdated }}');
            const packages = Object.keys(outdated);
            
            const title = `🔄 Dependency Update Available (${packages.length} packages)`;
            const body = `## Outdated Packages Detected
            
            The following packages have newer versions available:
            
            ${packages.map(pkg => {
              const info = outdated[pkg];
              return `- **${pkg}**: \`${info.current}\` → \`${info.latest}\` (${info.wanted})`;
            }).join('\n')}
            
            ### Recommended Actions:
            1. Review the changelog for each package
            2. Test the updates in a development environment
            3. Update packages incrementally
            4. Run the test suite after each update
            
            ---
            *This issue was automatically generated by the dependency check workflow.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'automated']
            });
      
      - name: Create issue for security vulnerabilities
        if: steps.audit.outputs.vulnerabilities != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditReport = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
            
            const title = `🚨 Security Vulnerabilities Detected (${{ steps.audit.outputs.vulnerabilities }} issues)`;
            const body = `## Security Audit Results
            
            **Total Vulnerabilities**: ${{ steps.audit.outputs.vulnerabilities }}
            
            ### Vulnerability Details:
            ${Object.values(auditReport.advisories || {}).map(adv => {
              return `- **${adv.title}** (Severity: ${adv.severity})
                - Module: ${adv.module_name}
                - Description: ${adv.overview}
                - Recommendation: ${adv.recommendation}`;
            }).join('\n\n')}
            
            ### Recommended Actions:
            1. Review each vulnerability
            2. Update affected packages
            3. Test thoroughly after updates
            4. Consider using \`npm audit fix\` for automatic fixes
            
            ---
            *This issue was automatically generated by the security audit workflow.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated', 'high-priority']
            });
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: audit-report.json
          retention-days: 7
